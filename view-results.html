<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Platform - Results</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="results-container">
        <header class="results-header">
            <div class="header-content">
                <button class="btn btn-outline" onclick="window.location.href='dashboard.html'">
                    ‚Üê Back to Dashboard
                </button>
                <h1 id="quizTitle">Quiz Results</h1>
                <div></div>
            </div>
        </header>

        <main class="results-main">
            <div class="results-overview">
                <div class="overview-stats">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3 id="participantCount">0</h3>
                            <p>Participants</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <h3 id="averageScore">0%</h3>
                            <p>Average Score</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-content">
                            <h3 id="highestScore">0%</h3>
                            <p>Highest Score</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-content">
                            <h3 id="questionCount">0</h3>
                            <p>Questions</p>
                        </div>
                    </div>
                </div>

                <div class="share-section">
                    <h3>Share Quiz</h3>
                    <p>Send this link to participants</p>
                    <div class="share-controls">
                        <input type="text" id="shareUrl" readonly onclick="this.select()">
                        <button class="btn btn-primary" id="copyLinkBtn">
                            üìã Copy Link
                        </button>
                    </div>
                </div>
            </div>

            <div class="results-section">
                <div class="results-controls">
                    <h2>Participant Results</h2>
                    <div class="controls-group">
                        <select id="sortBy" class="form-select">
                            <option value="date">Sort by Date</option>
                            <option value="score">Sort by Score</option>
                            <option value="name">Sort by Name</option>
                        </select>
                        <input type="text" id="searchParticipant" placeholder="Search participants..." class="form-input">
                    </div>
                </div>

                <div class="results-table-container">
                    <div class="results-empty" id="resultsEmpty">
                        <div class="empty-icon">‚è∞</div>
                        <h3>No participants yet</h3>
                        <p>Share your quiz link to get started!</p>
                    </div>
                    
                    <table class="results-table" id="resultsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Participant</th>
                                <th>Score</th>
                                <th>Correct Answers</th>
                                <th>Completed</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        let currentQuiz = null;
        let allResults = [];
        let filteredResults = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const currentUser = checkAuth();
            if (!currentUser) return;

            // Get quiz ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quiz');
            
            if (!quizId) {
                showToast('Quiz not found', 'error');
                window.location.href = 'dashboard.html';
                return;
            }

            loadQuizResults(quizId);
            setupEventListeners();
        });

        function loadQuizResults(quizId) {
            currentQuiz = getQuiz(quizId);
            
            if (!currentQuiz) {
                showToast('Quiz not found', 'error');
                window.location.href = 'dashboard.html';
                return;
            }

            // Set quiz title
            document.getElementById('quizTitle').textContent = currentQuiz.title;
            document.getElementById('questionCount').textContent = currentQuiz.questions.length;

            // Set share URL
            const baseUrl = window.location.origin + window.location.pathname.replace('view-results.html', '');
            const shareUrl = `${baseUrl}take-quiz.html?quiz=${quizId}`;
            document.getElementById('shareUrl').value = shareUrl;

            // Load results
            allResults = getQuizResults(quizId);
            updateResultsDisplay();
        }

        function setupEventListeners() {
            document.getElementById('copyLinkBtn').addEventListener('click', copyShareLink);
            document.getElementById('sortBy').addEventListener('change', handleSort);
            document.getElementById('searchParticipant').addEventListener('input', handleSearch);
        }

        function updateResultsDisplay() {
            filteredResults = [...allResults];
            updateStats();
            displayResults();
        }

        function updateStats() {
            const participantCount = allResults.length;
            const averageScore = participantCount > 0 
                ? Math.round(allResults.reduce((sum, result) => sum + result.score, 0) / participantCount)
                : 0;
            const highestScore = participantCount > 0 
                ? Math.max(...allResults.map(result => result.score))
                : 0;

            document.getElementById('participantCount').textContent = participantCount;
            document.getElementById('averageScore').textContent = averageScore + '%';
            document.getElementById('highestScore').textContent = highestScore + '%';
        }

        function displayResults() {
            const resultsEmpty = document.getElementById('resultsEmpty');
            const resultsTable = document.getElementById('resultsTable');
            const resultsTableBody = document.getElementById('resultsTableBody');

            if (filteredResults.length === 0) {
                resultsEmpty.style.display = 'flex';
                resultsTable.style.display = 'none';
                return;
            }

            resultsEmpty.style.display = 'none';
            resultsTable.style.display = 'table';

            // Clear existing rows
            resultsTableBody.innerHTML = '';

            // Add result rows
            filteredResults.forEach(result => {
                const row = document.createElement('tr');
                const scoreClass = result.score >= 80 ? 'score-excellent' : result.score >= 60 ? 'score-good' : 'score-poor';
                
                row.innerHTML = `
                    <td>
                        <div class="participant-info">
                            <div class="participant-avatar">${result.participantName.charAt(0).toUpperCase()}</div>
                            <span class="participant-name">${escapeHtml(result.participantName)}</span>
                        </div>
                    </td>
                    <td>
                        <span class="score-badge ${scoreClass}">
                            ${result.score}%
                        </span>
                    </td>
                    <td>
                        <span class="correct-answers">
                            ${result.correctAnswers}/${result.totalQuestions}
                        </span>
                    </td>
                    <td>
                        <span class="completion-date">
                            ${formatDateTime(result.completedAt)}
                        </span>
                    </td>
                `;
                
                resultsTableBody.appendChild(row);
            });
        }

        function handleSort() {
            const sortBy = document.getElementById('sortBy').value;
            
            filteredResults.sort((a, b) => {
                switch (sortBy) {
                    case 'score':
                        return b.score - a.score;
                    case 'name':
                        return a.participantName.localeCompare(b.participantName);
                    case 'date':
                    default:
                        return new Date(b.completedAt).getTime() - new Date(a.completedAt).getTime();
                }
            });
            
            displayResults();
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchParticipant').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredResults = [...allResults];
            } else {
                filteredResults = allResults.filter(result => 
                    result.participantName.toLowerCase().includes(searchTerm)
                );
            }
            
            handleSort(); // Apply current sort to filtered results
        }

        function copyShareLink() {
            const shareUrl = document.getElementById('shareUrl');
            shareUrl.select();
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl.value).then(() => {
                    showToast('Quiz link copied to clipboard!', 'success');
                }).catch(() => {
                    showToast('Please copy the link manually', 'info');
                });
            } else {
                showToast('Please copy the link manually', 'info');
            }
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
    </script>
</body>
</html>